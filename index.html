<!DOCTYPE html>
<html lang="en">

<style>
    #cart-items {
        font-size: 0.9em; /* Adjust the font size as needed */
    }
    #cart-items th, #cart-items td {
        padding: 5px; /* Adjust the padding as needed */
    }
    #cart-items th {
        text-align: left;
    }

    .featured-group {
        background-color: #e0f7fa; /* Light cyan background */
        border: 4px solid #00acc1; /* Cyan border */
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
    }

    .featured-group h3 {
        color: #00796b; /* Teal color for the header text */
        font-weight: bold;
        text-transform: uppercase;
    }

    
    .modal-body .row {
        display: flex;
    }

    .modal-body .col-md-8 {
        flex: 2;
    }

    .quantity-btn {
        border-color: #ced4da; /* Match the border color of the input */
        background-color: #ffffff; /* Match the background color of the input */
        color: #495057; /* Match the text color of the input */
    }

    .quantity-btn:hover,
    .quantity-btn:focus,
    .quantity-btn:active {
        background-color: #e9ecef; /* Slightly darker background on hover */
        border-color: #ced4da; /* Match the border color of the input */
        color: #6c757d; /* Darker color when highlighted */
    }

    .input-group .form-control {
        border-color: #ced4da; /* Ensure the input has the same border color */
    }

    /* Override the btn-outline-secondary class */
    .btn-outline-secondary {
        border-color: #ced4da !important; /* Match the border color of the input */
        color: #495057 !important; /* Match the text color of the input */
    }

    .btn-outline-secondary:hover,
    .btn-outline-secondary:focus,
    .btn-outline-secondary:active {
        background-color: #e9ecef !important; /* Slightly darker background on hover */
        border-color: #ced4da !important; /* Match the border color of the input */
        color: #6c757d !important; /* Darker color when highlighted */
    }

    .btn-group-toggle { 
        display: flex; justify-content: center; flex-wrap: wrap;
     }
    .btn-group-toggle .btn { 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: auto; flex: 1 1 auto; 
    } 

    .modal-footer {
        text-align: left;
    }

    .modal-footer h5,
    .modal-footer label,
    .modal-footer span {
        display: block;
        width: 100%;
    }

    .d-flex {
        display: flex;
    }

    .justify-content-center {
        justify-content: center;
    }

    /* Mobile view */
    @media (max-width: 768px) {
        .sticky-header {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure it stays on top of other elements */
            padding: 10px; /* Optional: add some padding if needed */
            backdrop-filter: blur(5px); /* Add blur effect */
            border-bottom: none; /* Remove bottom border */
            width: 100%; /* Make the header span the entire width */
            left: 0; /* Ensure it starts from the left edge */
        }
    }

    @media (min-width: 769px) {
        .sticky-header {
            position: -webkit-sticky; /* For Safari */
            top: 0;
            z-index: 1000; /* Ensure it stays on top of other elements */
            padding: 10px; /* Optional: add some padding if needed */
            backdrop-filter: blur(5px); /* Add blur effect */
            border-bottom: none; /* Remove bottom border */
            width: 100%; /* Make the header span the entire width */
            left: 0; /* Ensure it starts from the left edge */
        }
    }

    .form-group {
        display: flex;
        justify-content: center; /* Center the content horizontally */
        align-items: center; /* Center the content vertically */
        width: 100%;
    }

    .btn-group-toggle {
        display: flex;
        justify-content: center; /* Center the buttons horizontally */
        flex-wrap: wrap;
    }

    .btn-group-toggle .btn {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: auto;
        flex: 1 1 auto;
    }

    .sticky-top {
        position: fixed;
        top: 0;
        right: 0;
        z-index: 1020;
    }

    .shopping-cart {
        position: fixed;
        top: 0;
        right: -300px; /* Adjust the width as needed */
        width: 300px;
        height: 100%;
        background-color: white;
        box-shadow: -2px 0 5px rgba(0,0,0,0.5);
        transition: right 0.3s ease;
        z-index: 1050;
    }

    .shopping-cart.show {
        right: 0;
    }

    .close { 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        font-size: 1.5rem; 
        cursor: pointer;
     }

     body {
        background: linear-gradient(135deg, #00c6ff, #0072ff, #00c6ff);
        /* Fallback for older browsers */
        background: -webkit-linear-gradient(135deg, #00c6ff, #0072ff, #00c6ff);
        background: -moz-linear-gradient(135deg, #00c6ff, #0072ff, #00c6ff);
        background: -o-linear-gradient(135deg, #00c6ff, #0072ff, #00c6ff);
        background: -ms-linear-gradient(135deg, #00c6ff, #0072ff, #00c6ff);
    }

    body.dark-mode {
        background: linear-gradient(135deg, #333333, #000000, #333333);
        /* Fallback for older browsers */
        background: -webkit-linear-gradient(135deg, #333333, #000000, #333333);
        background: -moz-linear-gradient(135deg, #333333, #000000, #333333);
        background: -o-linear-gradient(135deg, #333333, #000000, #333333);
        background: -ms-linear-gradient(135deg, #333333, #000000, #333333);
    }

    
    h2, h3 {
        color: white; /* Default color for larger screens */
        text-shadow: 1px 1px 2px #333333; /* Dark gray outline */
    }

    @media (max-width: 768px) {
        h2, h3 {
            color: black; /* Black text for mobile devices */
            text-shadow: none; /* Remove the outline for mobile */
        }
    }


    .logo {
         max-width: 200px; /* Adjust the value as needed */ 
         width: 50%; 
         height: auto; 
    } 

    .btn-craft-flavor { 
        background: linear-gradient(135deg, #ff7e5f, #feb47b); 
        border: none; 
        color: #ffffff; 
        font-size: 3rem; /* Increase the font size */ 
        padding: 20px 40px; /* Increase padding */ 
        border-radius: 10px; 
        transition: background 0.3s ease; 
    }

    .btn-craft-flavor:hover 
    { 
        background: linear-gradient(135deg, #feb47b, #ff7e5f); 
    }

    body.dark-mode {
        background: linear-gradient(135deg, #333333, #000000, #333333);
        /* Fallback for older browsers */
        background: -webkit-linear-gradient(135deg, #333333, #000000, #333333);
        background: -moz-linear-gradient(135deg, #333333, #000000, #333333);
        background: -o-linear-gradient(135deg, #333333, #000000, #333333);
        background: -ms-linear-gradient(135deg, #333333, #000000, #333333);
        color: #ffffff;
    }

    .dark-mode .btn-primary {
        background-color: #1a73e8;
        border-color: #1a73e8;
    }

    .dark-mode .btn-secondary {
        background-color: #333333;
        border-color: #333333;
    }

    .dark-mode .card {
        background-color: #1e1e1e;
        color: #ffffff;
    }

    .dark-mode h2, .dark-mode h3 {
        color: #ffffff;
    }

    .dark-mode .modal-content {
        background-color: #1e1e1e;
        color: #ffffff;
    }

    .dark-mode .modal-header, .dark-mode .modal-body, .dark-mode .modal-footer {
        border-color: #333333;
    }

    .btn-dark-mode {
        background-color: #444444;
        color: #ffffff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-dark-mode:hover {
        background-color: #555555;
    }

    .dark-mode .btn-dark-mode {
        background-color: #ffffff;
        color: #444444;
    }

    .dark-mode .btn-dark-mode:hover {
        background-color: #dddddd;
    }

    .dark-mode th, .dark-mode td { 
        border-color: #333333;
        color: #ffffff; /* Text color for table headers and cells */
    }



</style>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Ice Cream</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12 text-center">
                <img src="Images/Micah's Cookies and Creams Final.png" alt="Micah's Cookies and Creams Logo" class="img-fluid mb-4 logo">
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <button class="btn-craft-flavor btn-block mb-3 bsb-btn-5xl" data-toggle="modal" data-target="#customizeModal"> Craft A Flavor </button>
                <h2>Pick A Flavor</h2>
                <div class="row" id="flavor-cards">
                </div>
            </div>
            <div class="fixed-top text-right p-3">
                <button class="btn btn-dark" id="darkModeToggle">Toggle Dark Mode</button>
                <button class="btn btn-secondary" type="button" onclick="toggleCart()">
                    <i class="fas fa-shopping-cart"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="shoppingCart" class="shopping-cart">
        <div class="card card-body">
            <button type="button" class="close" aria-label="Close" onclick="toggleCart()">
                <span aria-hidden="true">&times;</span>
            </button>
            <ul id="cart-items" class="list-group">
                <!-- Cart items will be added here -->
            </ul>
            <p class="mt-2">Total: $<span id="total-price">0.00</span></p>
        </div>
    </div>

    <!-- Flavor Card Template -->
    <template id="flavor-card-template">
        <div class="col-md-6"> <!-- Changed to col-md-6 for wider cards -->
            <div class="card">
                <img src="" class="card-img-top" alt="">
                <div class="card-body">
                    <h5 class="card-title"></h5>
                    <p class="card-price"></p>
                    <div class="form-group mb-3"> 
                        <div class="d-flex align-items-center">
                            <div class="btn-group btn-group-toggle" data-toggle="buttons" id="size-flavor"> </div>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <button class="btn btn-outline-secondary quantity-btn" type="button" onclick="decreaseQuantity(this)">-</button>
                        </div>
                        <input type="number" value="1" class="form-control text-center quantity" min="1">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary quantity-btn" type="button" onclick="increaseQuantity(this)">+</button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-primary mt-2 add-to-cart">Add to Cart</button>
                        <button class="btn btn-secondary mt-2 customize-btn" data-toggle="modal" data-target="#customizeModal">Customize It!</button>
                    </div>
                </div>
            </div>
        </div>
    </template>    

    <!-- Customize Modal -->
    
    <div class="modal fade" id="customizeModal" tabindex="-1" role="dialog" aria-labelledby="customizeModalLabel"
    aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customizeModalLabel">Customize Your Ice Cream!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="customizeForm">
                                <input type="hidden" id="cartItemId" value="">
                                <h5>Name</h5>
                                <div class="form-group mb-3"> 
                                    <label for="name">Name</label>
                                    <input class="form-control" id="name"></input>
                                </div>
                                <h5>Milk Types</h5>
                                <div class="form-group mb-3"> 
                                    <label for="iceCreamBase">Pick An Ice Cream Base</label>                          
                                </div>
                                <div class="d-flex align-items-center">
                                    <select class="form-control" id="iceCreamBase" onchange="updateMilkTypes(this.value)"></select>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="milkType1">Pick Your Primary Milk Type</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="milkType1" required></select> 
                                        <span class="ml-2" id="milkType1Price"></span>
                                    </div>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="milkType2">Pick Your Secondary Milk Type</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="milkType2" required></select>
                                        <span class="ml-2" id="milkType2Price"></span>
                                    </div>
                                </div>
                                <h5>Flavors</h5>
                                <div class="form-group mb-3"> 
                                    <label for="liquidMix1">Pick A Flavor</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="liquidMix1" required></select> 
                                    </div>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="liquidMix1Amount">Amount</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="liquidMix1Amount" required></select> 
                                        <span class="ml-2" id="liquidMix1Price"></span>
                                    </div>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="liquidMix2">Pick A Second Flavor (Optional)</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="liquidMix2"></select>
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('liquidMix2');">Clear</button>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="liquidMix2Amount">Amount</label>
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="liquidMix2Amount"></select> 
                                        <span class="ml-2" id="liquidMix2Price"></span>
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('liquidMix2Amount');">Clear</button>
                                </div>
                                <h5>Mix-ins (Optional)</h5>
                                <div class="form-group mb-3"> 
                                    <label for="mixIn1">Pick A First Mix In</label>
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="mixIn1"></select> 
                                        <span class="ml-2" id="mixIn1Price"></span>
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('mixIn1');">Clear</button>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="mixIn2">Pick A Second Mix In</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="mixIn2"></select> 
                                        <span class="ml-2" id="mixIn2Price"></span>
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('mixIn2');">Clear</button>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="mixIn1Amount">Amount (%)</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="mixInAmount"></select>  
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('mixInAmount');">Clear</button>
                                </div>
                                <h5>Sweeteners</h5>
                                <div class="form-group mb-3"> 
                                    <label for="sweetener1">Pick A First Sweetner</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="sweetener1" required></select>
                                    </div>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="sweetener1Amount">Amount</label>
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="sweetener1Amount" required></select> 
                                        <span class="ml-2" id="sweetener1Price"></span>
                                    </div>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="sweetener2">Pick A Second Sweetner (Optional)</label> 
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="sweetener2">
                                            <option value="" disabled selected>Select an option</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('sweetener2');">Clear</button>
                                </div>
                                <div class="form-group mb-3"> 
                                    <label for="sweetener2Amount">Amount</label>
                                    <div class="d-flex align-items-center">
                                        <select class="form-control" id="sweetener2Amount">
                                            <option value="" disabled selected>Select an option</option>
                                        </select> 
                                        <span class="ml-2" id="sweetener2Price"></span>
                                    </div>
                                    <button type="button" class="btn btn-link" onclick="clearField('sweetener2Amount')">Clear</button>
                                </div>
                                <h5>Size</h5>
                                <div class="form-group mb-3"> 
                                    <div class="d-flex align-items-center">
                                        <div class="btn-group btn-group-toggle" data-toggle="buttons" id="size-customize"> </div>
                                        <span class="ml-2" id="sizePrice"></span>
                                    </div>
                                </div>
                                <h5>Quantity</h5>
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-outline-secondary quantity-btn" type="button" onclick="decreaseQuantity(this)">-</button>
                                    </div>
                                    <input type="number" value="1" class="form-control text-center quantity" id="quantity-customize" min="1">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary quantity-btn" type="button" onclick="increaseQuantity(this)">+</button>
                                    </div>
                                </div>
                
                            </form>
                        </div> 
                        <div class="modal-footer">
                            <h5 class="text-left">Pricing</h5>
                            <div class="input-group mb-3">
                                <label for="additionalCosts" class="w-100 text-left">Additional Costs</label>
                                <div class="d-flex w-100">
                                    <span class="ml-2" id="additionalCosts"></span>
                                </div>
                            </div>
                            <div class="input-group mb-3">
                                <label for="pricePerQuantity" class="w-100 text-left">Price Per Quantity</label>
                                <div class="d-flex w-100">
                                    <span class="ml-2" id="pricePerQuantity"></span>
                                </div>
                            </div>
                            <h5 class="text-left">Total Price</h5>
                            <div class="d-flex w-100">
                                <span class="ml-2" id="totalPrice"></span>
                            </div>
                        </div>                                                                     
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="customizeAddToCart" onclick="validateForm(this)">Add To Cart</button>                
                        </div>
                    </div>
                </div>                                    
            </div>
        </div>
    </div>

    <!--Cart item-->
    <template id="cart-item-template">
        <div class="cart-item">
            <h5 class="cart-item-name"></h5>
            <span class="cart-item-price" style="display: block; font-size: 1.25rem;"></span>
            <button class="btn btn-link" type="button" onclick="toggleTable(this)">
                Show/Hide Ingredients
            </button>            
            <div class="collapse collapse-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Details</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ice Cream Base</td>
                            <td class="ice-cream-base"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Primary Milk Type</td>
                            <td class="milk-type1"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Secondary Milk Type</td>
                            <td class="milk-type2"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Flavor 1</td>
                            <td class="liquid-mix1"></td>
                            <td class="liquid-mix1-amount"></td>
                        </tr>
                        <tr>
                            <td>Flavor 2</td>
                            <td class="liquid-mix2"></td>
                            <td class="liquid-mix2-amount"></td>
                        </tr>
                        <tr>
                            <td>Mix In 1</td>
                            <td class="mix-in1"></td>
                            <td class="mix-in-amount"></td>
                        </tr>
                        <tr>
                            <td>Mix In 2</td>
                            <td class="mix-in2"></td>
                            <td class="mix-in-amount"></td>
                        </tr>
                        <tr>
                            <td>Sweetener 1</td>
                            <td class="sweetener1"></td>
                            <td class="sweetener1-amount"></td>
                        </tr>
                        <tr>
                            <td>Sweetener 2</td>
                            <td class="sweetener2"></td>
                            <td class="sweetener2-amount"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="form-group">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <button class="btn btn-outline-secondary quantity-btn" type="button" onclick="decreaseQuantity(this); updateTotalPrice();">-</button>
                    </div>
                    <input type="number" class="form-control text-center quantity" value="1" min="1" onchange="updateTotalPrice()">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary quantity-btn" type="button" onclick="increaseQuantity(this); updateTotalPrice();">+</button>
                    </div>
                </div>
            </div>            
            <div class="d-flex justify-content-center">
                <button type="button" class="btn btn-secondary btn-sm w-100" onclick="editCartItem(this)">Edit</button>
                <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeCartItem(this)">Remove</button>
            </div>
        </div>
    </template>
     

    <script>
        let workbook;
        let additionalCosts;
        let upcharge;

        // storing worksheet as dictionaries to minimize future for loop needs
        let milkWorksheet;
        let flavorWorksheet;
        let solidMixInWorksheet;
        let sweetenerWorksheet;
        let premadeWorksheet;

        // storing specs dictionaries for pricing
        let sizeSpecsDict = {}; 
        let liquidSpecs = {};
        let solidSpecs = {};
        let sweetenerSpecs = {};

        function toggleCart() {
            const cart = document.getElementById('shoppingCart');
            cart.classList.toggle('show');
        }

        function clearField(fieldId) {
            document.getElementById(fieldId).value = '';
            calculateCustomizePrice();
        }

        function validateForm(button) {
            var form = document.getElementById('customizeForm');
            var isValid = true;

            // Check all required select elements
            var requiredSelects = form.querySelectorAll('select[required]');
            requiredSelects.forEach(function(select) {
                if (select.value === '') {
                    isValid = false;
                    select.classList.add('is-invalid'); // Add Bootstrap invalid class
                } else {
                    select.classList.remove('is-invalid'); // Remove Bootstrap invalid class
                }
            });

            if (isValid) {
                const cartItemId = document.getElementById('cartItemId').value;

                // Get the selected values
                const name = document.getElementById('name').value;
                const iceCreamBase = document.getElementById('iceCreamBase').value;
                const milkType1 = document.getElementById('milkType1').value;
                const milkType2 = document.getElementById('milkType2').value;
                const liquidMix1 = document.getElementById('liquidMix1').value;
                const liquidMix1Amount = document.getElementById('liquidMix1Amount').value;
                const liquidMix2 = document.getElementById('liquidMix2').value;
                const liquidMix2Amount = document.getElementById('liquidMix2Amount').value;
                const mixIn1 = document.getElementById('mixIn1').value;
                const mixIn2 = document.getElementById('mixIn2').value;
                const mixInAmount = document.getElementById('mixInAmount').value;
                const sweetener1 = document.getElementById('sweetener1').value;
                const sweetener1Amount = document.getElementById('sweetener1Amount').value;
                const sweetener2 = document.getElementById('sweetener2').value;
                const sweetener2Amount = document.getElementById('sweetener2Amount').value;
                const size = document.querySelector('input[name="size"]:checked').value; // Get the selected size value
                const quantity = document.getElementById('quantity-customize').value;
                const totalPrice = document.getElementById('totalPrice').textContent;

                // Create a cart item using the template
                const template = document.getElementById('cart-item-template');
                const cartItem = template.content.cloneNode(true).querySelector('.cart-item');
                cartItem.id = cartItemId || `cart-item-${Date.now()}`;

                // Update the cart item with the selected values
                cartItem.querySelector('.cart-item-name').textContent = `${name} - ${size}`;
                cartItem.querySelector('.ice-cream-base').textContent = iceCreamBase;
                cartItem.querySelector('.milk-type1').textContent = milkType1;
                cartItem.querySelector('.milk-type2').textContent = milkType2;
                cartItem.querySelector('.liquid-mix1').textContent = liquidMix1;
                cartItem.querySelector('.liquid-mix1-amount').textContent = liquidMix1Amount;
                cartItem.querySelector('.liquid-mix2').textContent = liquidMix2;
                cartItem.querySelector('.liquid-mix2-amount').textContent = liquidMix2Amount;
                cartItem.querySelector('.mix-in1').textContent = mixIn1;
                cartItem.querySelector('.mix-in2').textContent = mixIn2;
                cartItem.querySelector('.mix-in-amount').textContent = mixInAmount;
                cartItem.querySelector('.sweetener1').textContent = sweetener1;
                cartItem.querySelector('.sweetener1-amount').textContent = sweetener1Amount;
                cartItem.querySelector('.sweetener2').textContent = sweetener2;
                cartItem.querySelector('.sweetener2-amount').textContent = sweetener2Amount;
                console.log("Setting quantity to ", quantity);
                cartItem.querySelector('.quantity').value = quantity;
                cartItem.querySelector('.cart-item-price').textContent = `${totalPrice}`;

                if (cartItemId) {
                    // Update the existing cart item
                    document.getElementById(cartItemId).outerHTML = cartItem.outerHTML;
                } else {
                    // Add the new cart item to the table
                    document.querySelector('#cart-items').appendChild(cartItem);
                }

                // Close the modal
                $('#customizeModal').modal('hide');
                const cart = document.getElementById('shoppingCart');
                if (!cart.classList.contains('show')) {
                    cart.classList.add('show');
                }

                // Update the total price (assuming you have a function to calculate the total price)
                updateTotalPrice();
            }
        }
        
        function toggleTable(button) {
            const cartItem = button.closest('.cart-item');
            const table = cartItem.querySelector('.collapse-table');
            $(table).collapse('toggle');
        }


        function updateTotalPrice() {
            // Calculate the total price based on the cart items
            let totalPrice = 0.00;

            // Iterate through each cart item and calculate the total price
            document.querySelectorAll('.cart-item').forEach(cartItem => {
                const quantity = parseInt(cartItem.querySelector('.quantity').value);
                console.log("Quantity is: ", quantity);
                const price = parseFloat(cartItem.querySelector('.cart-item-price').textContent.replace('$', ''));
                console.log("Price is: ", price);
                totalPrice += quantity * price;
            });

            console.log("Total price is now : ", totalPrice);

            // Update the total price element
            document.getElementById('total-price').textContent = totalPrice.toFixed(2);
        }


        function editCartItem(button) { 

            cartItem = button.closest('.cart-item');

            cartItemId = cartItem.id;

            console.log("Cart item ID is ", cartItemId);
            // Get the cart item row 
            const cartItemContainer = document.getElementById(cartItemId); 
            
            // Get the values from the cart item table
            const nameSizeText = cartItemContainer.querySelector('h5').textContent;
            const [name, size] = nameSizeText.split(' - ');
            const iceCreamBase = cartItemContainer.querySelector('tbody tr:nth-child(1) td:nth-child(2)').textContent;
            const milkType1 = cartItemContainer.querySelector('tbody tr:nth-child(2) td:nth-child(2)').textContent;
            const milkType2 = cartItemContainer.querySelector('tbody tr:nth-child(3) td:nth-child(2)').textContent;
            const liquidMix1 = cartItemContainer.querySelector('tbody tr:nth-child(4) td:nth-child(2)').textContent;
            const liquidMix1Amount = cartItemContainer.querySelector('tbody tr:nth-child(4) td:nth-child(3)').textContent;
            const liquidMix2 = cartItemContainer.querySelector('tbody tr:nth-child(5) td:nth-child(2)').textContent;
            const liquidMix2Amount = cartItemContainer.querySelector('tbody tr:nth-child(5) td:nth-child(3)').textContent;
            const mixIn1 = cartItemContainer.querySelector('tbody tr:nth-child(6) td:nth-child(2)').textContent;
            const mixInAmount = cartItemContainer.querySelector('tbody tr:nth-child(6) td:nth-child(3)').textContent;
            const mixIn2 = cartItemContainer.querySelector('tbody tr:nth-child(7) td:nth-child(2)').textContent;
            const sweetener1 = cartItemContainer.querySelector('tbody tr:nth-child(8) td:nth-child(2)').textContent;
            const sweetener1Amount = cartItemContainer.querySelector('tbody tr:nth-child(8) td:nth-child(3)').textContent;
            const sweetener2 = cartItemContainer.querySelector('tbody tr:nth-child(9) td:nth-child(2)').textContent;
            const sweetener2Amount = cartItemContainer.querySelector('tbody tr:nth-child(9) td:nth-child(3)').textContent;
            const quantity = cartItemContainer.querySelector('.quantity').value;

            // Set the values in the customize modal
            document.getElementById('name').value = name;
            document.getElementById('iceCreamBase').value = iceCreamBase;
            document.getElementById('milkType1').value = milkType1;
            document.getElementById('milkType2').value = milkType2;
            document.getElementById('liquidMix1').value = liquidMix1;
            document.getElementById('liquidMix1Amount').value = liquidMix1Amount;
            document.getElementById('liquidMix2').value = liquidMix2;
            document.getElementById('liquidMix2Amount').value = liquidMix2Amount;
            document.getElementById('mixIn1').value = mixIn1;
            document.getElementById('mixInAmount').value = mixInAmount;
            document.getElementById('mixIn2').value = mixIn2;
            document.getElementById('sweetener1').value = sweetener1;
            document.getElementById('sweetener1Amount').value = sweetener1Amount;
            document.getElementById('sweetener2').value = sweetener2;
            document.getElementById('sweetener2Amount').value = sweetener2Amount;
            document.getElementById('size-customize').value = size;
            document.getElementById('quantity-customize').value = quantity;

            // Set the cart item ID in the hidden input field 
            document.getElementById('cartItemId').value = cartItemId; 
            // Change the button text to "Update" 
            document.getElementById('customizeAddToCart').textContent = 'Update'; 
            // Open the customize modal 
            $('#customizeModal').modal('show');
        }

        function removeCartItem(button) {

            cartItem = button.closest('.cart-item');

            // Remove the cart item
            document.getElementById(cartItem.id).remove();

            // Update the total price (assuming you have a function to calculate the total price)
            updateTotalPrice();
        }

        $(document).ready(function() {
            $('#customizeModal').on('hidden.bs.modal', function () {
                resetCustomizeModal();
            });
        });

        function resetCustomizeModal() {
            // Reset form fields
            $('#name').val(''); 
            $('#iceCreamBase').val(''); 
            $('#milkType1').val(''); 
            $('#milkType1Price').val(''); 
            $('#milkType2').val(''); 
            $('#milkType2Price').val(''); 
            $('#liquidMix1').val(''); 
            $('#liquidMix1Amount').val(''); 
            $('#liquidMix1Price').val(''); 
            $('#liquidMix2').val('');
             $('#liquidMix2Amount').val(''); 
             $('#liquidMix2Price').val(''); 
             $('#mixIn1').val(''); 
             $('#mixIn1Price').val(''); 
             $('#mixIn2').val(''); 
             $('#mixIn2Price').val(''); 
             $('#mixIn1Amount').val(''); 
             $('#sweetener1').val(''); 
             $('#sweetener1Amount').val(''); 
             $('#sweetener1Price').val(''); 
             $('#sweetener2').val(''); 
             $('#sweetener2Amount').val(''); 
             $('#sweetener2Price').val(''); 
             $('#size-customize').val('');
             $('#quantity-customize').val(1);
             $('#additionalCosts').val(''); 
             $('#pricePerQuantity').val(''); 
             $('#totalPrice').val('');
             document.getElementById('cartItemId').value = ''; // Reset the cart item ID 
             document.getElementById('customizeAddToCart').textContent = 'Add To Cart';
            // Optionally, reset other elements or states within the modal
        }

        function populateFlavorCards(sheetName) {
            var worksheet = workbook.Sheets[sheetName]; 
            var specsWorksheet = workbook.Sheets["Specs"]; 

            var flavorCardsContainer = document.getElementById('flavor-cards');
            flavorCardsContainer.innerHTML = ''; // Clear existing flavor cards

            var currentGroup = null;
            var featuredGroup = null;

            // get size values
            // Handle size options as buttons
            var sizeOptions = [];

            for (var i = 2; i <= Object.keys(specsWorksheet).length; i++) { // Skip header row 
                var cellAddress = `${"A"}${i}`; 
                var cell = specsWorksheet[cellAddress]; 
                if (cell && cell.v) { 
                    sizeOptions.push(cell.v);
                }
            }

            for (var i = 2; i <= Object.keys(worksheet).length; i++) { // Skip header row 
                var flavorCellAddress = `A${i}`; 
                var priceCellAddress = `AJ${i}`; 
                var imageCellAddress = `A${i}`; 

                var flavorCell = worksheet[flavorCellAddress]; 
                var priceCell = worksheet[priceCellAddress]; 
                var imageCell = worksheet[imageCellAddress]; 
                if (flavorCell && flavorCell.v){
                    var flavor = flavorCell.v; 

                    if (flavor === "_NOT FEATURED") 
                    { 
                        break; // End the loop if the flavor is "_NOT FEATURED" 
                    }

                    if (flavor.startsWith('_')) {
                        if (flavor.includes("FEATURED:")) {
                                // Create a new featured group header
                                featuredGroup = document.createElement('div'); 
                                featuredGroup.className = 'row flavor-group featured-group'; 

                                // Create a sticky header
                                var header = document.createElement('div');
                                header.className = 'sticky-header';
                                header.innerHTML = `<h3 class="col-12">${flavor.replace("FEATURED:", "").trim().substring(1)}</h3>`;
                                featuredGroup.appendChild(header);

                                flavorCardsContainer.insertAdjacentElement('afterbegin', featuredGroup);
                            }
                            else {
                            // Create a new group header
                            featuredGroup = null;
                            currentGroup = document.createElement('div'); 
                            currentGroup.className = 'row flavor-group'; 

                            // Create a sticky header
                            var header = document.createElement('div');
                            header.className = 'sticky-header';
                            header.innerHTML = `<h3 class="col-12">${flavor.substring(1)}</h3>`;
                            currentGroup.appendChild(header);

                            flavorCardsContainer.appendChild(currentGroup);
                        }

                    } else {
                        if (priceCell && priceCell.v && imageCell && imageCell.v) { 
                            var price = calculateCustomizePriceFromFlavor(sizeOptions[0],flavor);
                            var imageUrl = `images/${imageCell.v}.png`;

                            // Clone the template
                            var template = document.getElementById('flavor-card-template');
                            var clone = template.content.cloneNode(true);

                            // Populate the clone with data
                            clone.querySelector('.card-img-top').src = imageUrl;
                            clone.querySelector('.card-img-top').alt = flavor;
                            clone.querySelector('.card-title').textContent = flavor;
                            clone.querySelector('.card-price').textContent = `$${price}`;

                            // Create a new sizeElement for each flavor card
                            var sizeElement = document.createElement('div');
                            sizeOptions.forEach((optionValue, index) => {
                                var input = document.createElement('input'); 
                                
                                input.type = 'radio'; 
                                input.name = `size-flavor-${flavor}`; // Use unique name for each flavor
                                input.value = optionValue; 
                                input.id = `size-flavor-${flavor}-${optionValue}`; 

                                var label = document.createElement('label'); 
                                label.className = 'btn btn-outline-primary'; 
                                label.setAttribute('for', input.id); 
                                label.innerHTML = optionValue; 

                                if (index === 0) { 
                                    input.checked = true; // Set the first button as active by default 
                                    label.classList.add('active', 'focus'); // Add the "active" and "focus" classes to the first label
                                }
                                // Append the input element to the label 
                                label.appendChild(input);

                                sizeElement.appendChild(label);
                            });

                            clone.querySelector('#size-flavor').innerHTML = sizeElement.innerHTML;
                            clone.querySelector('.form-control').id = `quantity-${flavor.toLowerCase()}`;
                            clone.querySelector('.add-to-cart').setAttribute('data-flavor', flavor);
                            clone.querySelector('.customize-btn').setAttribute('data-flavor', flavor);

                            if (featuredGroup) 
                            { 
                                featuredGroup.appendChild(clone); 
                            } else if (currentGroup) 
                            { 
                                currentGroup.appendChild(clone);
                            } else { 
                                flavorCardsContainer.appendChild(clone); 
                            }
                        }

                    }
                }
            }

            // Add event listener for size buttons using document.querySelectorAll
            document.querySelectorAll('input[name^="size-flavor-"]').forEach(input => {
                input.addEventListener('change', function() {
                    var flavor = this.name.split('-')[2];
                    var newSize = this.value;
                    var newPrice = calculateCustomizePriceFromFlavor(newSize, flavor);
                    this.closest('.card-body').querySelector('.card-price').textContent = `$${newPrice}`;
                });
            });

            // Add event listener for label class changes
            document.querySelectorAll('label[for^="size-flavor-"]').forEach(label => {
                label.addEventListener('click', function() {
                    setTimeout(() => {
                        if (this.classList.contains('active')) {
                            var parts = this.getAttribute('for').split('-'); 
                            var flavor = parts.slice(2, -1).join('-'); 
                            var newSize = parts[parts.length - 1];
                            var newPrice = calculateCustomizePriceFromFlavor(newSize, flavor);
                            this.closest('.card-body').querySelector('.card-price').textContent = `$${newPrice}`;
                        }
                    }, 0);
                });
            });

            // Add event listener for "Customize It!" buttons 
            document.querySelectorAll('.customize-btn').forEach(button => { 
                button.addEventListener('click', function() { 
                    var flavor = this.getAttribute('data-flavor'); 
                    var size = document.querySelector(`#size-flavor .btn.active input`); // Get the selected size
                    if(!size){
                        size = Object.keys(sizeSpecsDict)[0];
                    }else{
                        size = size.value
                    }

                    var quantity = document.getElementById(`quantity-${flavor.toLowerCase()}`).value;
                    autoSelectValues(flavor, worksheet, size, quantity); 
                }); 
            });

            // Add event listener for "Add to Cart" buttons
            document.querySelectorAll('.add-to-cart').forEach(button => { 
                button.addEventListener('click', function() { 
                    var flavor = this.getAttribute('data-flavor'); 
                    var quantity = this.closest('.card-body').querySelector('.quantity').value;
                    var sizeElement = this.closest('.card-body').querySelector('input[name^="size-flavor-"]:checked');
                    var size = sizeElement ? sizeElement.value : '';

                    var priceElement = this.closest('.card-body').querySelector('.card-price'); 

                    addToCart(flavor, premadeWorksheet, quantity, priceElement.innerText, size); 
                }); 
            });

        }




        function decreaseQuantity(button) {
            const input = button.closest('.input-group').querySelector('.quantity');
            let value = parseInt(input.value);
            if (value > 1) {
                value--;
                input.value = value;
            }
            calculateCustomizePrice();
        }

        function increaseQuantity(button) {
            const input = button.closest('.input-group').querySelector('.quantity');
            let value = parseInt(input.value);
            value++;
            input.value = value;
            calculateCustomizePrice();
        }

        function addToCart(flavor, worksheet, quantity,price,size) {
            var name = flavor;
            var iceCreamBase = "";

            var milkType1 = worksheet[flavor]["Milk Type 1 (2/3)"];
            var milkType2 = worksheet[flavor]["Milk Type 2 (1/3)"];
            var liquidMix1 = worksheet[flavor]["Liquid Mix 1"];
            var liquidMix1Amount = worksheet[flavor]["Liquid Mix 1 Amount (x tbsp)"];
            var liquidMix2 = worksheet[flavor]["Liquid Mix 2"];
            var liquidMix2Amount = worksheet[flavor]["Liquid Mix 2 Amount (x tbsp)"];
            var mixIn1 = worksheet[flavor]["Solid Mix 1"];
            var mixIn2 = worksheet[flavor]["Solid Mix 2"];
            var mixInAmount = worksheet[flavor]["Solid Mix Amount (% of all ice cream)"];
            var sweetener1 = worksheet[flavor]["Sweetner Type 1"];
            var sweetener1Amount = worksheet[flavor]["Sweetner Type 1 Amount (x 100g)"];
            var sweetener2 = worksheet[flavor]["Sweetner Type 2"];
            var sweetener2Amount = worksheet[flavor]["Sweetner Type 2 Amount (x 100g)"];

            // Get the template and clone it
            const template = document.getElementById('cart-item-template');
            const cartItem = template.content.cloneNode(true);

            // Generate a unique ID for the cart item and collapse div
            const uniqueId = `cart-item-${Date.now()}`;

            // Set the values
            cartItem.querySelector('.cart-item').id = uniqueId;
            cartItem.querySelector('.cart-item-name').textContent = `${name} - ${size}`;
            cartItem.querySelector('.ice-cream-base').textContent = iceCreamBase;
            cartItem.querySelector('.milk-type1').textContent = milkType1;
            cartItem.querySelector('.milk-type2').textContent = milkType2;
            cartItem.querySelector('.liquid-mix1').textContent = liquidMix1;
            cartItem.querySelector('.liquid-mix1-amount').textContent = liquidMix1Amount;
            cartItem.querySelector('.liquid-mix2').textContent = liquidMix2;
            cartItem.querySelector('.liquid-mix2-amount').textContent = liquidMix2Amount;
            cartItem.querySelector('.mix-in1').textContent = mixIn1;
            cartItem.querySelector('.mix-in2').textContent = mixIn2;
            cartItem.querySelector('.mix-in-amount').textContent = mixInAmount;
            cartItem.querySelector('.sweetener1').textContent = sweetener1;
            cartItem.querySelector('.sweetener1-amount').textContent = sweetener1Amount;
            cartItem.querySelector('.sweetener2').textContent = sweetener2;
            cartItem.querySelector('.sweetener2-amount').textContent = sweetener2Amount;
            cartItem.querySelector('.quantity').value = quantity;
            cartItem.querySelector('.cart-item-price').innerText = price;

            // Set the collapse div ID and button data-target
            const collapseDiv = cartItem.querySelector('.collapse');
            collapseDiv.id = uniqueId;
            cartItem.querySelector('.btn-link').setAttribute('data-target', `#${uniqueId}`);

            // Append the cart item to the cart
            document.querySelector('#cart-items').appendChild(cartItem);

            // Update the total price (assuming you have a function to calculate the total price)
            updateTotalPrice();

            const cart = document.getElementById('shoppingCart');
            if (!cart.classList.contains('show')) {
                cart.classList.add('show');
            }

        }

        function setCustomizeValue(worksheet, i, column, elementId) { 
            const value = worksheet[`${column}${i}`] ? worksheet[`${column}${i}`].v : ''; 
            document.getElementById(elementId).value = value;
        }

        function calculateSegmentPrice(worksheet, specsDict, sizeSpecsDict, value, amountValue, size, priceId) {
            if (value === '' || amountValue === '' || !worksheet.hasOwnProperty(value)) {
                if (priceId) document.getElementById(priceId).innerText = ``;
                return { amount: 0, price: 0 };
            }

            var amount = (specsDict[amountValue] * sizeSpecsDict[size].Multiplier); 
            
            
            var cost = worksheet[value]["Cost ($)"];

            var price = amount * cost * upcharge;
            price = price.toFixed(2);
            
            if (priceId) document.getElementById(priceId).innerText = `$${price}`;

            if (worksheet[value].hasOwnProperty("Thick?")) {
                if (worksheet[value]["Thick?"] === "Yes") {
                    amount = 0;               
                }
            }

            if (worksheet === flavorWorksheet) {
                amount = amount * 15;
            } else if (worksheet === sweetenerWorksheet) {
                // TODO: need to use custom gram value when calculating costs
            }

            return { amount: amount, price: parseFloat(price) };
        }

        function calculateSolidPrice(worksheet, specsDict, sizeSpecsDict, value1, amountValue, size, priceId, value2, price2Id) {
            var splitAmount = 0.5;

            if (value1 === '' || amountValue === '' || !worksheet.hasOwnProperty(value1)) {
                if (priceId) document.getElementById(priceId).innerText = ``;
                if (price2Id) document.getElementById(price2Id).innerText = ``;
                return { cupAmount: 0, price1: 0, price2: 0 };
            }

            if (value2 === '' || !worksheet.hasOwnProperty(value2)) {
                splitAmount = 1;
                if (price2Id) document.getElementById(price2Id).innerText = ``;
            }

            var cupAmount = (sizeSpecsDict[size].Amount * specsDict[amountValue]);

            var value1gramsPerCup = worksheet[value1]["grams (from cups)"];
            var value1grams = cupAmount / 240 * value1gramsPerCup * splitAmount;
            var cost1 = worksheet[value1]["Cost ($)"];
            var price1 = (value1grams / value1gramsPerCup) * upcharge * cost1;
            price1 = price1.toFixed(2);
            if (priceId) document.getElementById(priceId).innerText = `$${price1}`;
            
            var price2 = 0;
            if (value2 !== '' && worksheet.hasOwnProperty(value2) && worksheet[value2].hasOwnProperty("grams (from cups)")) {
                var value2gramsPerCup = worksheet[value2]["grams (from cups)"];
                var value2grams = cupAmount / 240 * value2gramsPerCup * splitAmount;
                var cost2 = worksheet[value2]["Cost ($)"];
                price2 = (value2grams / value2gramsPerCup) * upcharge * cost2;
                price2 = price2.toFixed(2);
                if (price2Id) document.getElementById(price2Id).innerText = `$${price2}`;
            }

            return { cupAmount: cupAmount, price1: parseFloat(price1), price2: parseFloat(price2) };
        }

        function calculateMilkPrice(worksheet, sizeSpecsDict, value, size, priceId, milkPortion, totalGramsBeforeMilk) {
            if (value === '') {
                if (priceId) document.getElementById(priceId).innerText = ``;
                return 0;
            }

            var cost = worksheet[value]["Cost ($)"];
            var price = (((sizeSpecsDict[size].Amount - totalGramsBeforeMilk) * milkPortion) / 240) * cost * upcharge;
            price = price.toFixed(2);
            if (priceId) document.getElementById(priceId).innerText = `$${price}`;                   

            return parseFloat(price);
        }

        function calculateCustomizePrice() {
            var size = document.querySelector(`#size-customize input[name="size"]:checked`).value; 

            var liquidMix1 = calculateSegmentPrice(flavorWorksheet, liquidSpecs, sizeSpecsDict, document.getElementById('liquidMix1').value, document.getElementById('liquidMix1Amount').value, size, 'liquidMix1Price');
            var liquidMix2 = calculateSegmentPrice(flavorWorksheet, liquidSpecs, sizeSpecsDict, document.getElementById('liquidMix2').value, document.getElementById('liquidMix2Amount').value, size, 'liquidMix2Price');
            var sweetener1 = calculateSegmentPrice(sweetenerWorksheet, sweetenerSpecs, sizeSpecsDict, document.getElementById('sweetener1').value, document.getElementById('sweetener1Amount').value, size, 'sweetener1Price');
            var sweetener2 = calculateSegmentPrice(sweetenerWorksheet, sweetenerSpecs, sizeSpecsDict, document.getElementById('sweetener2').value, document.getElementById('sweetener2Amount').value, size, 'sweetener2Price');
            var solidSimulated = calculateSolidPrice(solidMixInWorksheet, solidSpecs, sizeSpecsDict, document.getElementById('mixIn1').value, document.getElementById('mixInAmount').value, size, 'mixIn1Price', document.getElementById('mixIn2').value, 'mixIn2Price');

            var totalGramsBeforeMilk = liquidMix1.amount + liquidMix2.amount + solidSimulated.cupAmount;

            var milkType1Price = calculateMilkPrice(milkWorksheet, sizeSpecsDict, document.getElementById('milkType1').value, size, 'milkType1Price', 2/3, totalGramsBeforeMilk);
            var milkType2Price = calculateMilkPrice(milkWorksheet, sizeSpecsDict, document.getElementById('milkType2').value, size, 'milkType2Price', 1/3, totalGramsBeforeMilk);

            var currentAdditionalCosts = (additionalCosts + sizeSpecsDict[size].ContainerCost) * upcharge;
            document.getElementById("additionalCosts").innerText = `$${currentAdditionalCosts.toFixed(2)}`;

            var liquidMix1Price = liquidMix1.price || 0;
            var liquidMix2Price = liquidMix2.price || 0;
            var sweetener1Price = sweetener1.price || 0;
            var sweetener2Price = sweetener2.price || 0;
            var mixIn1Price = solidSimulated.price1 || 0;
            var mixIn2Price = solidSimulated.price2 || 0;

            var pricePerQuantity = milkType1Price + milkType2Price + liquidMix1Price + liquidMix2Price + sweetener1Price + sweetener2Price + mixIn1Price + mixIn2Price + currentAdditionalCosts;
            document.getElementById("pricePerQuantity").innerText = `$${pricePerQuantity.toFixed(2)}`;

            var quantity = document.getElementById('quantity-customize').value;
            var totalPrice = pricePerQuantity * quantity;
            document.getElementById("totalPrice").innerText = `$${totalPrice.toFixed(2)}`;
        }


        function calculateCustomizePriceFromFlavor(size,flavor) {
            var flavorValues = premadeWorksheet[flavor];

            var liquidMix1 = calculateSegmentPrice(flavorWorksheet, liquidSpecs, sizeSpecsDict, flavorValues["Liquid Mix 1"], flavorValues["Liquid Mix 1 Amount (x tbsp)"], size, null);
            var liquidMix2 = calculateSegmentPrice(flavorWorksheet, liquidSpecs, sizeSpecsDict, flavorValues["Liquid Mix 2"], flavorValues["Liquid Mix 2 Amount (x tbsp)"], size, null);
            var sweetener1 = calculateSegmentPrice(sweetenerWorksheet, sweetenerSpecs, sizeSpecsDict, flavorValues["Sweetner Type 1"], flavorValues["Sweetner Type 1 Amount (x 100g)"], size, null);
            var sweetener2 = calculateSegmentPrice(sweetenerWorksheet, sweetenerSpecs, sizeSpecsDict, flavorValues["Sweetner Type 2"], flavorValues["Sweetner Type 2 Amount (x 100g)"], size, null);
            var solidSimulated = calculateSolidPrice(solidMixInWorksheet, solidSpecs, sizeSpecsDict, flavorValues["Solid Mix 1"], flavorValues["Solid Mix Amount (% of all ice cream)"], size, null, flavorValues["Solid Mix 2"], null);

            var totalGramsBeforeMilk = liquidMix1.amount + liquidMix2.amount + solidSimulated.cupAmount;

            var milkType1Price = calculateMilkPrice(milkWorksheet, sizeSpecsDict, flavorValues["Milk Type 1 (2/3)"], size, null, 2/3, totalGramsBeforeMilk);
            var milkType2Price = calculateMilkPrice(milkWorksheet, sizeSpecsDict, flavorValues["Milk Type 2 (1/3)"], size, null, 1/3, totalGramsBeforeMilk);

            var currentAdditionalCosts = (additionalCosts + sizeSpecsDict[size].ContainerCost) * upcharge;

            var liquidMix1Price = liquidMix1.price || 0;
            var liquidMix2Price = liquidMix2.price || 0;
            var sweetener1Price = sweetener1.price || 0;
            var sweetener2Price = sweetener2.price || 0;
            var mixIn1Price = solidSimulated.price1 || 0;
            var mixIn2Price = solidSimulated.price2 || 0;

            var pricePerQuantity = milkType1Price + milkType2Price + liquidMix1Price + liquidMix2Price + sweetener1Price + sweetener2Price + mixIn1Price + mixIn2Price + currentAdditionalCosts;

            return pricePerQuantity.toFixed(2);
        }


        function autoSelectValues(flavor, worksheet,size,quantity) { 
            for (var i = 2; i <= Object.keys(worksheet).length; i++) { 
                // Skip header row 
                var flavorCellAddress = `A${i}`; 
                var flavorCell = worksheet[flavorCellAddress]; 
                if (flavorCell && flavorCell.v && flavorCell.v.toLowerCase() === flavor.toLowerCase()) { 
                    

                    document.getElementById("name").value = flavor;
                    document.getElementById("quantity-customize").value = quantity;

                    const milkTypeWorksheet = workbook.Sheets['Milk Types Nutrition Per Cup'];

                    // Set the selected size to the element with id "size"
                    var sizeElement = document.getElementById("size-customize");
                    sizeElement.querySelectorAll('label').forEach(label => {
                        var input = label.querySelector('input');
                        if (input.value === size) {
                            label.classList.add('active');
                            input.checked = true;
                        } else {
                            label.classList.remove('active');
                            input.checked = false;
                        }
                    });

                    //TODO update this to use the dictionaries to simplify
                    setCustomizeValue(worksheet, i, 'B', 'milkType1'); 
                    setCustomizeValue(worksheet, i, 'C', 'milkType2'); 

                    var milkType1 = document.getElementById("milkType1").value;
                    var milkType2 = document.getElementById("milkType2").value;

                    const matchingBase = findMatchingIceCreamBase(milkType1, milkType2, milkTypeWorksheet);

                    if (matchingBase) {
                        document.getElementById('iceCreamBase').value = matchingBase;
                    }

                    setCustomizeValue(worksheet, i, 'D', 'liquidMix1'); 
                    setCustomizeValue(worksheet, i, 'K', 'liquidMix1Amount'); 
                    setCustomizeValue(worksheet, i, 'E', 'liquidMix2'); 
                    setCustomizeValue(worksheet, i, 'L', 'liquidMix2Amount');
                    setCustomizeValue(worksheet, i, 'F', 'mixIn1'); 
                    setCustomizeValue(worksheet, i, 'G', 'mixIn2'); 
                    setCustomizeValue(worksheet, i, 'M', 'mixInAmount'); 
                    setCustomizeValue(worksheet, i, 'H', 'sweetener1'); 
                    setCustomizeValue(worksheet, i, 'N', 'sweetener1Amount'); 
                    setCustomizeValue(worksheet, i, 'I', 'sweetener2'); 
                    setCustomizeValue(worksheet, i, 'O', 'sweetener2Amount'); 
                    
                    calculateCustomizePrice();
                    break; 
                } 
            } 
        }

        //based on the selected Ice Cream Base, adjusts the milk types
        function updateMilkTypes(iceCreamBase) { 
            var milkTypeWorksheet = workbook.Sheets['Milk Types Nutrition Per Cup'];

            var rowIndex = findRowIndex(iceCreamBase,milkTypeWorksheet); 

            if (rowIndex !== -1) { 
                const milkType1 = milkTypeWorksheet[`P${rowIndex}`] ? milkTypeWorksheet[`P${rowIndex}`].v : ''; 
                const milkType2 = milkTypeWorksheet[`Q${rowIndex}`] ? milkTypeWorksheet[`Q${rowIndex}`].v : ''; 
                
                document.getElementById('milkType1').value = milkType1; 
                document.getElementById('milkType2').value = milkType2; 
            } 
        } 
        
        function findRowIndex(iceCreamBase,milkTypeWorksheet) { 
            for (let key in milkTypeWorksheet) { 
                if (key.startsWith('O')) { 
                    const rowIndex = key.slice(1); 
                    if (milkTypeWorksheet[key] && milkTypeWorksheet[key].v === iceCreamBase) { 
                        return rowIndex; 
                    } 
                } 
            } 
            return -1
        }
        
        //Checks if the combination of milk types align with any of the ice cream bases
        function updateIceCreamBase() {
            const milkType1 = document.getElementById('milkType1').value;
            const milkType2 = document.getElementById('milkType2').value;
            const milkTypeWorksheet = workbook.Sheets['Milk Types Nutrition Per Cup'];

            const matchingBase = findMatchingIceCreamBase(milkType1, milkType2, milkTypeWorksheet);

            if (matchingBase) {
                document.getElementById('iceCreamBase').value = matchingBase;
            }
        }

        function findMatchingIceCreamBase(milkType1, milkType2, milkTypeWorksheet) {
            for (let key in milkTypeWorksheet) {
                if (key.startsWith('O')) {
                    const rowIndex = key.slice(1);
                    const baseMilkType1 = milkTypeWorksheet[`P${rowIndex}`] ? milkTypeWorksheet[`P${rowIndex}`].v : '';
                    const baseMilkType2 = milkTypeWorksheet[`Q${rowIndex}`] ? milkTypeWorksheet[`Q${rowIndex}`].v : '';

                    if (baseMilkType1 === milkType1 && baseMilkType2 === milkType2) {
                        return milkTypeWorksheet[key].v;
                    }
                }
            }
            return null;
        }

        document.getElementById('milkType1').addEventListener('change', updateIceCreamBase);
        document.getElementById('milkType2').addEventListener('change', updateIceCreamBase);

        // Function to populate select options from the specified column in the specified sheet 
        function populateOptions(sheetName, columnLetter, selectIds) { 
            var worksheet = workbook.Sheets[sheetName]; 
            selectIds.forEach(selectId => { 
                var selectElement = document.getElementById(selectId); 
                selectElement.innerHTML = ''; // Clear existing options 

                if (selectId === 'size-customize') {
                    // Handle size options as buttons
                    var sizeOptions = [];
                    for (var i = 2; i <= Object.keys(worksheet).length; i++) { // Skip header row 
                        var cellAddress = `${columnLetter}${i}`; 
                        var cell = worksheet[cellAddress]; 
                        if (cell && cell.v) { 
                            sizeOptions.push(cell.v);
                        }
                    }

                    sizeOptions.forEach(optionValue => {
                        var label = document.createElement('label');
                        label.className = 'btn btn-outline-primary';
                        label.innerHTML = `
                            <input type="radio" name="size" value="${optionValue}" onchange="calculateCustomizePrice()"> ${optionValue}`;
                        selectElement.appendChild(label);
                    });

                    // Set the first option as active by default
                    if (sizeOptions.length > 0) {
                        selectElement.firstChild.classList.add('active');
                        selectElement.firstChild.querySelector('input').checked = true;
                    }
                } else {
                    // Handle other options as <select> elements
                    // Add a default empty option 
                    var defaultOption = document.createElement('option'); 
                    defaultOption.text = 'Select an option'; 
                    defaultOption.value = ''; 
                    defaultOption.disabled = true; 
                    defaultOption.selected = true; 
                    selectElement.add(defaultOption);

                    for (var i = 2; i <= Object.keys(worksheet).length; i++) { // Skip header row 
                        var cellAddress = `${columnLetter}${i}`; 
                        var cell = worksheet[cellAddress]; 
                        if (cell && cell.v) { 
                            var cellValue = cell.v; 
                            var option = document.createElement('option'); 
                            option.text = cellValue;

                            // Find the corresponding price 
                            var priceCellAddress = `F${i}`; // Assuming the price is in column B 
                            var priceCell = worksheet[priceCellAddress]; 
                            if (priceCell && priceCell.v) { 
                                option.title = `Cost Per Amount: $${priceCell.v}`; // Set the tooltip with the price 
                            }

                            if (option.text.startsWith("_")) {
                                // Add a spacer option
                                var spacerOption = document.createElement('option'); 
                                spacerOption.text = '---'; // You can customize the spacer text 
                                spacerOption.disabled = true; // Make it non-selectable 
                                selectElement.add(spacerOption);

                                option.text = cellValue.substring(1);
                                option.style.fontWeight = 'bold'
                                option.disabled = true; // Make it non-selectable 
                            } 
                            selectElement.add(option); 
                        } 
                    } 
                }
            }); 
        }

        function populateOptionsFromList(dictionary,selectIds){

            selectIds.forEach(selectId => { 
                var selectElement = document.getElementById(selectId); 
                selectElement.innerHTML = ''; // Clear existing options 

                // Handle other options as <select> elements
                // Add a default empty option 
                var defaultOption = document.createElement('option'); 
                defaultOption.text = 'Select an option'; 
                defaultOption.value = ''; 
                defaultOption.disabled = true; 
                defaultOption.selected = true; 
                selectElement.add(defaultOption);

                for (let key in dictionary) { // Skip header row  
                    var option = document.createElement('option'); 
                    option.text = key;

                    option.title = `Cost Per Amount: $${dictionary[key]["Cost ($)"]}`; // Set the tooltip with the price 

                    if (key.startsWith("_")) {
                        // Add a spacer option
                        var spacerOption = document.createElement('option'); 
                        spacerOption.text = '---'; // You can customize the spacer text 
                        spacerOption.disabled = true; // Make it non-selectable 
                        selectElement.add(spacerOption);

                        option.text = key.substring(1);
                        option.style.fontWeight = 'bold'
                        option.disabled = true; // Make it non-selectable 
                    } 
                    selectElement.add(option); 
                } 
            }); 
        }

        function fillSpecsDictionary(worksheet, keyColumn, valueColumn, dictionary) {
            for (var i = 2; i <= Object.keys(worksheet).length; i++) {
                var keyCellAddress = `${keyColumn}${i}`;
                var keyCell = worksheet[keyCellAddress];
                if (keyCell && keyCell.v) {
                    var key = keyCell.v;
                    var valueCellAddress = `${valueColumn}${i}`;
                    var value = worksheet[valueCellAddress] ? worksheet[valueCellAddress].v : 0;
                    dictionary[key] = value;
                }
            }
        }
        
        // calculate custom price updates
        document.querySelector('#customizeForm').addEventListener('change', function(event) {
            if (event.target.matches('input, select, button')) {
                calculateCustomizePrice();
            }
        });

        document.querySelector('#size-customize').addEventListener('change', function(event) {
            if (event.target.matches('input[type="radio"], input, select, button')) {
                calculateCustomizePrice();
            }
        });

        document.querySelector('#quantity-customize').addEventListener('change', function(event) {
            calculateCustomizePrice();
        });

        function worksheetToDict(worksheetName) {

            worksheet = workbook.Sheets[worksheetName];

            let result = {};
            let range = XLSX.utils.decode_range(worksheet['!ref']);
            let firstRow = range.s.r;
            let firstCol = range.s.c;

            // Get the headers from the first row
            let headers = [];
            for (let col = firstCol + 1; col <= range.e.c; col++) {
                let cell = worksheet[XLSX.utils.encode_cell({r: firstRow, c: col})];
                if (cell && cell.v) {
                    headers.push(cell.v);
                } else {
                    break;
                }
            }

            // Iterate through each row and create the dictionary
            for (let row = firstRow + 1; row <= range.e.r; row++) {
                let keyCell = worksheet[XLSX.utils.encode_cell({r: row, c: firstCol})];
                if (keyCell && keyCell.v) {
                    let key = keyCell.v;
                    result[key] = {};
                    for (let col = firstCol + 1; col <= range.e.c; col++) {
                        let header = headers[col - firstCol - 1];
                        if (header) {
                            let cell = worksheet[XLSX.utils.encode_cell({r: row, c: col})];
                            result[key][header] = cell ? cell.v : null;
                        }
                    }
                }
            }
            return result;
        }

        document.addEventListener('DOMContentLoaded', () => {

            // retrieve the workbook data
            fetch('Ice Cream Master Document.xlsm') // Adjust URL as needed 
            .then(response => response.arrayBuffer()) 
            .then(data => { 
                workbook = XLSX.read(data, {type: 'array'});   

                   

                milkWorksheet = worksheetToDict("Milk Types Nutrition Per Cup");
                flavorWorksheet = worksheetToDict("Liquid Mix In Nutrition");
                solidMixInWorksheet = worksheetToDict("Solid Mix In Nutrition");
                sweetenerWorksheet = worksheetToDict("Sweetener Mix In Nutrition");
                premadeWorksheet = worksheetToDict("Premade Flavors");

               

                // setup sizeSpecsDict

                //Get spec amounts for storage with future parts
                var specsWorksheet = workbook.Sheets["Specs"];
                for (var i = 2; i <= Object.keys(specsWorksheet).length; i++) { 
                    var sizeCellAddress = `A${i}`; 
                    var sizeCell = specsWorksheet[sizeCellAddress];
                     if (sizeCell && sizeCell.v) { 
                        var size = sizeCell.v; 
                        var amountCellAddress = `B${i}`; 
                        var multiplierCellAddress = `C${i}`;
                        var containerCostCellAddress = `V${i}`; 
                        var amount = specsWorksheet[amountCellAddress] ? specsWorksheet[amountCellAddress].v : 0;
                        var multiplier = specsWorksheet[multiplierCellAddress] ? specsWorksheet[multiplierCellAddress].v : 0; 
                        var containerCost = specsWorksheet[containerCostCellAddress] ? specsWorksheet[containerCostCellAddress].v : 0; 
                        sizeSpecsDict[size] = { "Amount": amount, "Multiplier": multiplier, "ContainerCost": containerCost }; 
                    } 
                }

                additionalCosts = specsWorksheet['Q2'] ? specsWorksheet['Q2'].v : 0;
                upcharge = specsWorksheet['N2'] ? specsWorksheet['N2'].v : 0; 
                
                

                fillSpecsDictionary(specsWorksheet, 'D', 'E', liquidSpecs);
                fillSpecsDictionary(specsWorksheet, 'H', 'I', solidSpecs);
                fillSpecsDictionary(specsWorksheet, 'F', 'G', sweetenerSpecs);

                

                // populate drop downs for all the different areas (Used in Customize menus)
                populateOptions('Milk Types Nutrition Per Cup', "O", ['iceCreamBase']); 

                populateOptionsFromList(milkWorksheet,['milkType1', 'milkType2']);
                populateOptionsFromList(flavorWorksheet,['liquidMix1', 'liquidMix2']);
                populateOptionsFromList(solidMixInWorksheet,['mixIn1', 'mixIn2']);
                populateOptionsFromList(sweetenerWorksheet,['sweetener1', 'sweetener2']);

                populateOptions('Specs', "A", ['size-customize']); 
                populateOptions('Specs', "D", ['liquidMix1Amount','liquidMix2Amount']); 
                populateOptions('Specs', "F", ['sweetener1Amount','sweetener2Amount']); 
                populateOptions('Specs', "H", ['mixInAmount']);     

                // Populate all the flavors on then website
                populateFlavorCards('Premade Flavors');  
            });      
        });

        document.getElementById('darkModeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
        });

        function isNightTime() {
            const now = new Date();
            const hours = now.getHours();
            return hours >= 18 || hours < 6; // Nighttime is between 6 PM and 6 AM
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        // Automatically enable dark mode if it's nighttime
        if (isNightTime()) {
            document.body.classList.add('dark-mode');
        }

    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>